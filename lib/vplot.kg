:"Interactive visual plotter interface"
:"Requires Ghostscript and Ghostview on Unix"
:"Also works with gs(1) and page(1) on Plan 9"

helptext::[
"set.x(x;y;z)      set x-axis to x..y, step z"
"set.y(x;y;z)      set y-axis to x..y, step z"
"set.z(x;y;z)      set z-axis to x..y, step z"
"set.zsp(x)        set z-spacing to n (print only every x'th z-mark)"
"set.grid(x)       set grid density, 3=dense (default), 7=sparse, 0=off"
"set.font(x)       set font size in points (default: 12, 3d=1.5 times)"
"set.dot(x)        set dot size to x (default: 5)"
"set.res(x)        set resolution (50..500, default 200)"
"set.fill(x;y;z)   fill area from x to y, base line = z (usually 0)"
"set.nofill()      delete fill area"
"set.color(r;g;b)  set fill color to the given RGB values"
"v.plot(f)         2D-plot monadic function, e.g. {x^2}"
"v.plot3(f)        3D-plot dyadic function, e.g. {x*y}"
"v.area3(f)        3D-plot dyadic fn with color gradients, e.g. {x*y}"
"v.aplot(f;x1;xn)  plot function f with auto-scale from x1 to xn"
"v.bar(x)          bar-plot set x with auto-scaling"
"v.scatter(x)      scatter-plot set x with auto-scaling"
"v.scatter2(x)     scatter-plot x/y set x with auto-scaling"
"vp()              re-plot most recent function"
]

.l("nplot.kg")
.module(:vplot)
tmp::"vp",(2_$.rn()),".tmp"
p9.2d::"gs '-sOutputFile=-' -r96 -g800x800 -dBATCH -dNOPAUSE -q "
p9.2d::p9.2d,tmp," | page -b -w"
p9.3d::"gs '-sOutputFile=-' -r96 -g1133x1133 -dBATCH -dNOPAUSE -q "
p9.3d::p9.3d,tmp," | page -b -w"
u.2d::"gv -spartan -scale=0.7 -media=BBOX ",tmp
u.3d::"gv -spartan -scale=0.5 -media=BBOX ",tmp
v2c:::[.h~:plan9;p9.2d;u.2d]
v3c:::[.h~:plan9;p9.3d;u.3d]
xsc::[-1 1 0.1]
ysc::[-1 1 0.1]
zsc::[-1 1 0.1]
zsp::1
grd::3
dot::5
fnt::12
res::200
fun::{x}
dat::[]
fil::[]
plt::0
set.x::{xsc::x,y,z}
set.y::{ysc::x,y,z}
set.z::{zsc::x,y,z}
set.zsp::{zsp::x}
set.grid::{grd::x}
set.font::{fnt::x}
set.dot::{dot::x}
set.res::{res::x}
set.fill::{fil::x,y,z}
set.nofill::{fil::[]}
set.color::{fillrgb(x;y;z)}
v.aplot::{[c co];plt:::plot;.tc(c::.oc(tmp));
          set.x(y;z;0.1*#y-z);
          co::aplot(fun::x;y;z);
          .cc(c);.sys(v2c);.df(tmp);
          co::{rndn(x;*co)}'(-1)_1_co;
          set.y@co,0.1*#(*co)-co@1}
v.plot::{[c];plt:::plot;.tc(c::.oc(tmp));
         settext(fnt);setres(res);setgrid(grd);
         :[grd;grid(xsc;ysc);frame(xsc;ysc)];
         plot'fun::x;
         :[fil;area@fil;[]];
         :[fil;vline(*fil);[]];
         :[fil;vline(fil@1);[]];
         :[fil;:[grd;grid(xsc;ysc);frame(xsc;ysc)];[]];
         draw();
         .cc(c);.sys(v2c);.df(tmp);[]}
step::{:[~x>20;1
       :|~x>50;2
       :|~x>100;5
       :|~x>200;10
       :|~x>500;20
       :|~x>1000;50
       :|~x>2000;100
       ;rnd(0.1*x)]}
v.bar::{[c ff l h s];plt:::bar;.tc(c::.oc(tmp));
        settext(fnt);setgrid(grd);
        s::step((h::1+_|/x)-l::_&/x);dat::x;ff:::[grd;cgrid;cframe];
        ff($'1+!#x;0,(h+s),s);
        barplot(x);
        draw();
        .cc(c);.sys(v2c);.df(tmp);[]}
v.scatter::{[c ff s l h];plt:::scatter;.tc(c::.oc(tmp));
            settext(fnt);setgrid(grd);setdot(dot);
            dat::x;ff:::[grd;cgrid;cframe];s::step((h::1+_|/x)-l::_&/x);
            ff(:[30<#x;["data"];$'1+!#x];(l-s),(h+s),s);
            scplot(x);
            draw();
            .cc(c);.sys(v2c);.df(tmp);[]}
v.scatter2::{[c ff sx sy lx hx ly hy];plt:::scatter2;.tc(c::.oc(tmp));
             settext(fnt);setgrid(grd);setdot(dot);
             dat::x;ff:::[grd;grid;frame];
             sy::step((hy::1+_|/{x@1}'x)-ly::_&/{x@1}'x);
             sx::step((hx::|/*'x)-lx::&/*'x);
             ff((lx-sx),(hx+sx),sx;(ly-sy),(hy+sy),sy);
             scplot2(x);
             draw();
             .cc(c);.sys(v2c);.df(tmp);[]}
v.run::{[c ff s l h];plt:::run;.tc(c::.oc(tmp));
        settext(fnt);setgrid(grd);setdot(dot);
        dat::x;ff:::[grd;cgrid;cframe];s::step((h::1+_|/x)-l::_&/x);
        ff(:[30<#x;["data"];$'1+!#x];(l-s),(h+s),s);
        segplot(x);
        draw();
        .cc(c);.sys(v2c);.df(tmp);[]}
v.p::{[c p];p::y;.tc(c::.oc(tmp));
      settext(_1.5*fnt);setres(res);setgrid(grd);setzspace(zsp);
      :[grd;grid3(xsc;ysc;zsc);frame3(xsc;ysc;zsc)];
      p'fun::x;
      draw();
      .cc(c);.sys(v3c);.df(tmp);[]}
v.plot3::{plt:::plot3;v.p(x;plot3)}
v.area3::{plt:::area3;v.p(x;area3)}
vp::{:[plt~:bar;v.bar(dat)
     :|plt~:run;v.run(dat)
     :|plt~:scatter;v.scatter(dat)
     :|plt~:scatter2;v.scatter2(dat)
     :|plt~:plot;v.plot(fun)
     :|plt~:plot3;v.plot3(fun)
     :|plt~:area3;v.area3(fun)
     ;[]]}
vh::{.p'helptext;[]}
.module(0)
.p("vplot: type vh() for help")
